<!DOCTYPE html>
<html lang="fr">

<head>
    <meta charset="UTF-8">
    <!-- <META http-equiv="Refresh" content="nb de secondes; URL=Url de la page"> -->
        <!-- <META http-equiv="Refresh" content="2"> -->
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Accueil</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css"
        integrity="sha512-xodZBNTC5n17Xt2atTPuE1HxjVMSvLVW9ocqUKLsCC5CXdbqCmblAshOMAS6/keqq/sMZMZ19scR4PsZChSR7A=="
        crossorigin="" />
    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"
        integrity="sha512-XQoYMqMTK8LvdxXYG3nZ448hOEQiglfqkJs1NOQV44cWnUrBc8PkAOcXy20w0vlaXaVUearIOBhiXZ5V3ynxwA=="
        crossorigin=""></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css"
        integrity="sha384-EVSTQN3/azprG1Anm3QDgpJLIm9Nao0Yz1ztcQTwFspd3yD65VohhpuuCOmLASjC" crossorigin="anonymous">
    <style>
        * {
            text-decoration: none;
        }

        body {
            background-color: rgb(17, 147, 223);
            overflow-x: hidden;
        }

        main {
            display: flex;
            justify-content: space-around;

        }

        #mapid {
            width: 90%;
            height: 650px;
            border: 3px solid black;
        }
        .btn{
            font-weight: bold;
            font-size: 22px;
        }
        .btndeconnecter{
            margin-bottom: 10px;
            margin-top: -10px;
        }

    </style>
</head>

<body style="text-align:center" class="container-fluid">
    <h1 class="text-dark">Bienvenue dans la page de contrôle </h1>
    <button class="btn btn-warning"><a href="/crud">Zone CRUD</a></button>
    <h1 class="text-dark">Choisisser le champ à surveiller</h1>
    <!-- Image Map Generated by http://www.image-map.net/ -->
    <!--  <img src="{{ url_for('static', filename='img/sene.png')}}" usemap="#image-map">
    <map name="image-map">
        <area target="" alt="ZONE 1" title="ZONE 1" href="/charts" coords="47,316,12,281,9,238,127,261,165,199,189,144,212,149,230,143,249,124,327,134,329,169,299,215,300,286,317,300,299,320,299,338,270,348,249,347,238,368,259,368,240,378,219,400,231,409,235,427,243,447,238,461,247,469,263,494,185,492,152,460,150,409,107,347,70,320,62,332,52,324" shape="poly">
        <area target="" alt="ZONE 2" title="ZONE 2" href="/charts" coords="193,141,221,38,272,34,377,24,448,15,518,22,577,71,590,96,607,89,624,95,659,109,678,168,689,181,673,200,671,210,639,235,610,269,528,194,469,189,439,185,400,171,355,154,332,134,250,120,226,146,208,146" shape="poly">
        <area target="" alt="ZONE 3" title="ZONE 3" href="/charts" coords="267,493,344,494,365,461,388,466,413,457,442,465,455,485,488,487,497,503,522,511,562,498,584,506,605,435,633,377,622,323,637,283,600,265,569,235,531,200,482,194,440,190,408,178,363,164,335,142,318,190,306,212,305,251,310,284,321,306,305,335,285,348,250,354,246,362,261,366,226,402,244,414,249,444,243,456,256,479" shape="poly">
        <area target="" alt="ZONE 4" title="ZONE 4" href="/charts" coords="614,266,668,217,688,191,719,202,734,235,769,262,797,291,839,332,833,362,851,387,868,438,858,476,880,516,900,518,932,560,958,601,952,649,948,677,903,678,829,685,816,668,795,628,789,566,773,556,715,529,700,525,700,506,659,506,635,483,591,498,606,457,619,417,636,385,632,350,638,308,638,285,632,272" shape="poly">
        <area target="" alt="ZONE 5" title="ZONE 5" href="/charts" coords="159,589,172,553,295,553,295,524,372,520,396,489,443,513,520,541,559,535,583,512,609,504,645,502,655,516,681,517,696,519,709,533,782,567,789,614,794,631,799,642,816,671,820,680,802,685,768,682,737,665,704,668,694,655,691,643,548,635,394,638,331,674,270,675,229,675,178,685,151,685,150,664,146,606,150,593" shape="poly">
    </map> -->
    <main>
        <div id="mapid"></div>
    </main>
    <script>

        var mymap = L.map('mapid').setView([14.6937, -17.44406], 7);

        L.tileLayer('https://api.mapbox.com/styles/v1/{id}/tiles/{z}/{x}/{y}?access_token=pk.eyJ1IjoibWFwYm94IiwiYSI6ImNpejY4NXVycTA2emYycXBndHRqcmZ3N3gifQ.rJcFIG214AriISLbB6B5aw', {
            maxZoom: 18,
            attribution: 'Map data &copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors, ' +
                'Imagery © <a href="https://www.mapbox.com/">Mapbox</a>',
            id: 'mapbox/streets-v11',
            tileSize: 512,
            zoomOffset: -1
        }).addTo(mymap);

        ////////////////////////////////////////////////////////////////////////

        /*       function clicSurCarte(event) {
                   latofthemouse = event.latlng.lat;
                   lngofthemouse = event.latlng.lng;
                   alert(latofthemouse + " " + lngofthemouse);
               }
       
               mymap.addEventListener('mousemove', clicSurCarte);
               //mymap.on('mousemove', clicSurCarte);
       */
        ////////////////////////////////////////////////////////////////////////////


        function addMarker(i, j, l) {
            let marker = L.marker({ lat: i, lng: j }).addTo(mymap);
            var regAccentA = new RegExp('[|]', 'gi');
            newl = l.replace(regAccentA, '<br>');
            let readymarker = marker.bindPopup("<a href=/charts style='text-decoration:none'><h3>"+newl+"</h3></a>");
            mymap.on('zoomend', function () {
                if (mymap.getZoom() == 18 || mymap.getZoom() == 17 ) {


                    /*data.forEach(function () {
                        var m = L.marker({ lat: i, lng: j }).addTo(mymap),
                            p = new L.Popup({ autoClose: false, closeOnClick: false, autoPan: false})
                                .setContent(l)
                                .setLatLng({ lat: i, lng: j });
                        m.bindPopup(p).openPopup();
                        mymap.on('zoomanim', function () {
                            if (mymap.getZoom() != 17)
                                m.closePopup();
                        });
                    });*/
                    
                    function bbbb(i, j, l) {
                        let  m = L.marker({ lat: i, lng: j }).addTo(mymap);
                        var regAccentA = new RegExp('[|]', 'gi');
                        newl = l.replace(regAccentA, '<br>');
                            p = new L.Popup({ autoClose: false, closeOnClick: false, autoPan: false })
                                .setContent("<a href=/charts style='text-decoration:none'><h3>"+newl+"</h3></a>")
                                .setLatLng({ lat: i, lng: j });
                        m.bindPopup(p).openPopup();
                        mymap.on('zoomanim', function () {
                            if (mymap.getZoom() != 17){
                                m.closePopup();
                                mymap.removeLayer(m);

                            }
                        });
                        mymap.on('mousemove', function () {
                            m.closePopup();
                            mymap.removeLayer(m);

                        });
                        
                    }

                    //////////////////////////////////////////////
                    
                    function clicSurCarte(event) {
                        latofthemouse = event.latlng.lat;
                        lngofthemouse = event.latlng.lng;
                        left = j - 0.001193;
                        right = (j - (-0.001193));
                        bottom = i-0.001104;
                        thetop = (i-(-0.001104));
                        if (lngofthemouse >= left && lngofthemouse <=right && latofthemouse >=bottom && latofthemouse <=thetop){
                                bbbb(i, j, l);                                
                        }
                        
                        
                    }
                    mymap.addEventListener('mousemove', clicSurCarte);
                   
                    //////////////////////////////////////////////////////
                    //if (data.lng + 0.00400)
                    //bbbb(data.lat, data.lng, data.content);


                }else{
                    mymap.removeEventListener('mousemove', clicSurCarte);
                }
            });
        }


        /*fetch('/markersdata')
            .then(function (response) {
                return response.json();
            }).then(function (data) {
                for (var k = 0; k < data.length; k++)
                    addMarker(data[k].lat, data[k].lng, data[k].content)
            });*/

            
            

    </script>

    {% for row in rows %}  
        <script type="text/javascript">
            addMarker('{{row["lat"]}}','{{row["lng"]}}','{{row["content"]}}')
        </script>
    {% endfor %} 
    
    <br><br><br>
    <button class="btn btn-warning btndeconnecter"><a href="/dropsession">Se Deconnecter</a></button>

</body>

</html>